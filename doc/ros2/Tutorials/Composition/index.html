<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Composition</title>
    <meta name="description" content="a community-maintained index of robotics software
">

    <link rel="canonical" href="https://ros-infrastructure.github.io/index.ros.org//doc/ros2/Tutorials/Composition/">
    <link rel="stylesheet" type="text/css" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/main.css">
    

    <script type="text/javascript" src=/js/jquery.js></script>
    <script src=/bootstrap/js/bootstrap.min.js type="text/javascript"></script>
    <script src=/js/jquery-cookie-1.4.1/jquery.cookie.js type="text/javascript"></script>

    <script type="text/javascript" src=/js/ga.js async></script>
    <script type="text/javascript" src=/js/toc.js></script>

    <script src=/js/distro_switch.js></script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <div class="container-fluid" style="margin-bottom: 10px">

      <div align="center">
        <br>
        <table id="topnav-table">
          <tr>
            <td valign="middle">
                ROS Resources:
              <a href="http://wiki.ros.org/">Documentation</a>
              |
              <a href="http://wiki.ros.org/Support">Support</a>
              |
              <a href="http://discourse.ros.org/">Discussion Forum</a>
              |
              <a href="http://status.ros.org/">Service Status</a>
              |
              <a href="http://answers.ros.org/">Q&A answers.ros.org</a>
            </td>
          </tr>
        </table> <!-- topnav-table -->
      </div>

      <div class="row">

        <div class="col-sm-12 col-md-9" style="margin-top: 8px">
          <div class="row">
            <!-- title -->
            <div class="col-xs-12 col-sm-3 col-md-3" style="white-space:nowrap;">
              <a class="site-title" href="/">ROS Index</a> <sup><a href="https://github.com/ros-infrastructure/rosindex/issues/new" style="vertical-align:super;" class="label label-warning" target="_blank">BETA</a></sup>
            </div>

            <!-- main links -->
            <div class="col-xs-12 col-sm-9 col-md-9 text-right">
              <ul class="list-inline" style="margin-bottom:0px;">
                <li><a class="btn btn-link" href="/about">About</a></li>

                <li class="dropdown">
                  <button id="dLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Index <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    <li><a href="/packages/page/1/time/">Package List</a></li>
                    <li><a href="/repos/page/1/time/">Repository List</a></li>

                    <li class="hidden" class="divider"></li>


                    <li class="hidden"><a href="/srvs/">Nodes</a></li>
                    <li class="hidden"><a href="/msgs/">Messages</a></li>
                    <li class="hidden"><a href="/srvs/">Services</a></li>
                    <li class="hidden"><a href="/srvs/">Plugins</a></li>

                    <li class="divider"></li>

                    <li><a href="/deps/">System Dependencies</a></li>
                  </ul>
                </li>

                <li class="dropdown disabled">
                  <button id="dLabel" class="btn btn-link" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Doc <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    
                    <li>
                      <a href="/doc/ros2">
                        ROS2 Overview
                      </a>
                    </li>
                    
                    <li class="hidden" class="divider"></li>

                    <li class="hidden"><a href="/doc/tutorials">Tutorials</a></li>
                    <li class="hidden"><a href="/doc/readmes">Readmes</a></li>
                    <li class="hidden"><a href="/doc/apis">APIs</a></li>
                  </ul>
                </li>

                <li><a class="btn btn-link" href="/contribute">Contribute</a></li>
                <li><a class="btn btn-link" href="/stats">Stats</a></li>
              </ul>

            </div>
          </div>
        </div>

        <!-- searchbox -->
        <div class="col-sm-12 col-md-3" style="margin-top: 12px">
          <form id="top-searchbox" action="/search/" role="form" method="get">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" name="q" placeholder="Search ROS Packages">
              <span class="input-group-btn">
                <button class="btn btn-default btn-sm" title="Search ROS Packages" type="submit"><span class="glyphicon glyphicon-search"></span></button>
              </span>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!--
    <a class="site-title" href="/">ROS Index</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/packages">Packages</a>
        <a class="page-link" href="/repos">Repositories</a>
        <a class="page-link" href="/search">Search</a>
      </div>
    </nav>
    -->

  </div>
  <script type="text/javascript">
    $('#top-searchbox').submit(function() {
        return $('#top-searchbox input:text').filter(function() {
          return $(this).val() == "";
        }).length == 0;
    });
  </script>
</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="container-fluid" style="margin-top:20px">
  <div class="container-fluid">
    <div class="row">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li><a href="/doc/ros2/">ROS2 Overview</a></li>
        
        <li class="active">Composition</li>
        
      </ol>
    </div>
    <div class="row">
      <a type="button" href="https://github.com/ros2/ros2_documentation/edit/master/Tutorials/Composition.rst" class="btn btn-success pull-right">
        Edit on Github
      </a>
      <div class="section" id="composing-multiple-nodes-in-a-single-process">
<h1>Composing multiple nodes in a single process<a class="headerlink" href="#composing-multiple-nodes-in-a-single-process" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#ros-1-nodes-vs-nodelets" id="id1">ROS 1 - Nodes vs. Nodelets</a></li>
<li><a class="reference internal" href="#ros-2-unified-api" id="id2">ROS 2 - Unified API</a></li>
<li><a class="reference internal" href="#writing-a-component" id="id3">Writing a Component</a></li>
<li><a class="reference internal" href="#using-components" id="id4">Using Components</a></li>
<li><a class="reference internal" href="#run-the-demos" id="id5">Run the demos</a><ul>
<li><a class="reference internal" href="#run-time-composition-using-ros-services-1-with-a-publisher-and-subscriber" id="id6">Run-time composition using ROS services (1.) with a publisher and subscriber</a></li>
<li><a class="reference internal" href="#run-time-composition-using-ros-services-1-with-a-server-and-client" id="id7">Run-time composition using ROS services (1.) with a server and client</a></li>
<li><a class="reference internal" href="#compile-time-composition-using-ros-services-2" id="id8">Compile-time composition using ROS services (2.)</a></li>
<li><a class="reference internal" href="#run-time-composition-using-dlopen" id="id9">Run-time composition using dlopen</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="ros-1-nodes-vs-nodelets">
<h2><a class="toc-backref" href="#id1">ROS 1 - Nodes vs. Nodelets</a><a class="headerlink" href="#ros-1-nodes-vs-nodelets" title="Permalink to this headline">¶</a></h2>
<p>In ROS 1 you can write your code either as a <a class="reference external" href="http://wiki.ros.org/Nodes">ROS node</a> or as a <a class="reference external" href="http://wiki.ros.org/nodelet">ROS nodelet</a>.
ROS 1 nodes are being compiled into executables.
ROS 1 nodelets on the other hand are being compiled into a shared library which is then being loaded at runtime by a container process.</p>
</div>
<div class="section" id="ros-2-unified-api">
<h2><a class="toc-backref" href="#id2">ROS 2 - Unified API</a><a class="headerlink" href="#ros-2-unified-api" title="Permalink to this headline">¶</a></h2>
<p>In ROS 2 the recommended way of writing your code is that of a nodelet - we call it a <code class="docutils literal"><span class="pre">Component</span></code>.
This enables to easily add common concepts to existing code, like a <a class="reference external" href="http://design.ros2.org/articles/node_lifecycle.html">life cycle</a>.
The biggest drawback of different APIs is being avoided in ROS 2 - both approaches can use the same API in ROS 2.</p>
<blockquote>
<div>It will still be possible to use the node-like style of &#8220;writing your own main&#8221; but for the common case it is not recommended.</div></blockquote>
<p>By making the process layout a deploy-time decision the user can choose between:</p>
<ul class="simple">
<li>running multiple nodes in separate processes with the benefits of process/fault isolation as well as easier debugging of individual nodes and</li>
<li>running multiple nodes in a single process with the lower overhead and optionally more efficient communication (see <a class="reference internal" href="../Intra-Process-Communication/"><em>Intra Process Communication</em></a>).</li>
</ul>
<p>The vision is that a future version of <code class="docutils literal"><span class="pre">ros2</span> <span class="pre">launch</span></code> will support making these different deployments easily configurable.</p>
</div>
<div class="section" id="writing-a-component">
<h2><a class="toc-backref" href="#id3">Writing a Component</a><a class="headerlink" href="#writing-a-component" title="Permalink to this headline">¶</a></h2>
<p>Since a component is only built into a shared library it doesn&#8217;t have a <code class="docutils literal"><span class="pre">main</span></code> function (see <a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/src/talker_component.cpp">Talker source code</a>).
A component subclasses from <code class="docutils literal"><span class="pre">rclcpp::Node</span></code>.
Since it is not in control of the thread it shouldn&#8217;t perform any long running or even blocking tasks in its constructor.
Instead it can use timers to get periodic notification.
Additionally it can create publishers, subscribers, servers, and clients.</p>
<p>An important aspect of making such a class a component is that the class registers itself using the package <code class="docutils literal"><span class="pre">class_loader</span></code> (see last line in the source code).
This makes the component discoverable when its library is being loaded into a running process - it acts as kind of an entry point.</p>
</div>
<div class="section" id="using-components">
<span id="composition-using-components"></span><h2><a class="toc-backref" href="#id4">Using Components</a><a class="headerlink" href="#using-components" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/ros2/demos/tree/master/composition">composition</a> package contains a couple of different approaches how to use components.
The two most common ones are:</p>
<ol class="arabic simple">
<li>You start a generic container process (<a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/src/api_composition.cpp">1</a>) and call the ROS service <a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/srv/LoadNode.srv">load_node</a> offered by the container.
The ROS service will then load the component specified by the passed package name and library name and start executing it within the running process.
Instead of calling the ROS service programmatically you can also use a <a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/src/api_composition_cli.cpp">command line tool</a> to invoke the ROS service with the passed command line arguments</li>
<li>You create a <a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/src/manual_composition.cpp">custom executable</a> containing multiple nodes which are known at compile time.
This approach requires that each component has a header file (which is not strictly needed for the first case).</li>
</ol>
</div>
<div class="section" id="run-the-demos">
<h2><a class="toc-backref" href="#id5">Run the demos</a><a class="headerlink" href="#run-the-demos" title="Permalink to this headline">¶</a></h2>
<p>The executables from the <a class="reference external" href="https://github.com/ros2/demos/tree/master/composition">composition</a> packages can be run with the following commands:</p>
<div class="section" id="run-time-composition-using-ros-services-1-with-a-publisher-and-subscriber">
<h3><a class="toc-backref" href="#id6">Run-time composition using ROS services (1.) with a publisher and subscriber</a><a class="headerlink" href="#run-time-composition-using-ros-services-1-with-a-publisher-and-subscriber" title="Permalink to this headline">¶</a></h3>
<p>In the first shell:</p>
<div class="highlight-bash"><div class="highlight"><pre>ros2 run composition api_composition
</pre></div>
</div>
<p>In the second shell (see <a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/src/talker_component.cpp">talker</a> source code):</p>
<div class="highlight-bash"><div class="highlight"><pre>ros2 run composition api_composition_cli composition composition::Talker
</pre></div>
</div>
<p>Now the first shell should show a message that the component was loaded as well as repeated message for publishing a message.</p>
<p>Another command in the second shell (see <a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/src/listener_component.cpp">listener</a> source code):</p>
<div class="highlight-bash"><div class="highlight"><pre>ros2 run composition api_composition_cli composition composition::Listener
</pre></div>
</div>
<p>Now the first shell should show repeated output for each received message.</p>
<blockquote>
<div>The demo uses hardcoded topic names and therefore you can&#8217;t run <code class="docutils literal"><span class="pre">api_composition</span></code> twice.
But in general it would be possible to run to separate container processes and load the talker and listener into separate ones and they would still communicate with each other.</div></blockquote>
</div>
<div class="section" id="run-time-composition-using-ros-services-1-with-a-server-and-client">
<h3><a class="toc-backref" href="#id7">Run-time composition using ROS services (1.) with a server and client</a><a class="headerlink" href="#run-time-composition-using-ros-services-1-with-a-server-and-client" title="Permalink to this headline">¶</a></h3>
<p>The example with a server and a client is very similar.</p>
<p>In the first shell:</p>
<div class="highlight-bash"><div class="highlight"><pre>ros2 run composition api_composition
</pre></div>
</div>
<p>In the second shell (see <a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/src/server_component.cpp">server</a> and <a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/src/client_component.cpp">client</a> source code):</p>
<div class="highlight-bash"><div class="highlight"><pre>ros2 run composition api_composition_cli composition composition::Server
ros2 run composition api_composition_cli composition composition::Client
</pre></div>
</div>
<p>In this case the client sends a request to the server, the server processes the request and replies with a response, and the client prints the received response.</p>
</div>
<div class="section" id="compile-time-composition-using-ros-services-2">
<h3><a class="toc-backref" href="#id8">Compile-time composition using ROS services (2.)</a><a class="headerlink" href="#compile-time-composition-using-ros-services-2" title="Permalink to this headline">¶</a></h3>
<p>This demos shows that the same shared libraries can be reused to compile a single executable running multiple components.
The executable contains all four components from above: talker and listener as well as server and client.</p>
<p>In the shell call (see <a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/src/manual_composition.cpp">source code</a>):</p>
<div class="highlight-bash"><div class="highlight"><pre>ros2 run composition manual_composition
</pre></div>
</div>
<p>This should show repeated messages from both pairs, the talker and the listener as well as the server and the client.</p>
</div>
<div class="section" id="run-time-composition-using-dlopen">
<h3><a class="toc-backref" href="#id9">Run-time composition using dlopen</a><a class="headerlink" href="#run-time-composition-using-dlopen" title="Permalink to this headline">¶</a></h3>
<p>This demo presents an alternative to 1. by creating a generic container process and pass it explicitly the libraries to load without using ROS interfaces.
The process will open each library and create one instance of each &#8220;rclcpp::Node&#8221; class in the library <a class="reference external" href="https://github.com/ros2/demos/blob/master/composition/src/dlopen_composition.cpp">source code</a>).</p>
<p><strong>Linux</strong> In the shell call:</p>
<div class="highlight-bash"><div class="highlight"><pre>ros2 run composition dlopen_composition <span class="sb">`</span>ros2 pkg prefix composition<span class="sb">`</span>/lib/libtalker_component.so <span class="sb">`</span>ros2 pkg prefix composition<span class="sb">`</span>/lib/liblistener_component.so
</pre></div>
</div>
<p><strong>OSX</strong> In the shell call:</p>
<div class="highlight-bash"><div class="highlight"><pre>ros2 run composition dlopen_composition <span class="sb">`</span>ros2 pkg prefix composition<span class="sb">`</span>/lib/libtalker_component.dylib <span class="sb">`</span>ros2 pkg prefix composition<span class="sb">`</span>/lib/liblistener_component.dylib
</pre></div>
</div>
<p><strong>Windows</strong> In cmd.exe call</p>
<div class="highlight-bash"><div class="highlight"><pre>ros2 pkg prefix composition
</pre></div>
</div>
<p>to get the path to where composition is installed. Then call</p>
<div class="highlight-bash"><div class="highlight"><pre>ros2 run composition dlopen_composition &lt;path_to_composition_install&gt;<span class="se">\b</span>in<span class="se">\t</span>alker_component.dll &lt;path_to_composition_install&gt;<span class="se">\b</span>in<span class="se">\l</span>istener_component.dll
</pre></div>
</div>
<p>Now the shell should show repeated output for each sent and received message.</p>
</div>
</div>
</div>

      &nbsp;
    </div>
  </div>
</div>

<script type="text/javascript">
$(document).ready(
    function() {
      $('#toc').toc({
        title: '',
        listType: 'ul',
        showSpeed: 0,
        headers: 'h2, h3' });
});
</script>

      </div>
    </div>

    <footer class="site-footer">
  <div class="wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-4 col-md-4">
          
            <a href="https://github.com/ros-infrastructure" title="Find rosindex in Github">
            <span class="icon  icon--github">
              <svg viewBox="0 0 16 16">
                <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>

            <span class="username">ros-infrastructure</span>
          </a>
          |
          <em>generated on 2019-01-22</em>
        
        </div>
        <div class="col-sm-8 col-md-8 text-right">
          <p class="text">a community-maintained index of robotics software
 | <a href="/privacy.txt">privacy</a></p>
        </div>
      </div>
    </div>
  </div>

</footer>


  </body>

</html>
